<!DOCTYPE html>
<html lang="en-NZ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" id="meta-description" content="Quality printing supplies from InkCartridges.co.nz">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="product">
    <meta property="og:site_name" content="InkCartridges.co.nz">
    <meta property="og:title" id="og-title" content="Product | InkCartridges.co.nz">
    <meta property="og:description" id="og-description" content="Quality printing supplies from InkCartridges.co.nz">
    <meta property="og:image" id="og-image" content="/assets/images/logo.png">
    <meta property="og:url" id="og-url" content="">
    <meta property="og:locale" content="en_NZ">
    <meta property="product:price:amount" id="og-price" content="">
    <meta property="product:price:currency" content="NZD">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" id="twitter-title" content="Product | InkCartridges.co.nz">
    <meta name="twitter:description" id="twitter-description" content="Quality printing supplies from InkCartridges.co.nz">
    <meta name="twitter:image" id="twitter-image" content="/assets/images/logo.png">

    <!-- Additional SEO -->
    <meta name="author" content="InkCartridges.co.nz">
    <meta name="geo.region" content="NZ">
    <meta name="geo.country" content="New Zealand">
    <link rel="canonical" id="canonical-url" href="">

    <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
    <title id="page-title">Product | InkCartridges.co.nz</title>

    <!-- Schema.org BreadcrumbList -->
    <script type="application/ld+json" id="breadcrumb-schema">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://inkcartridges.co.nz/" },
            { "@type": "ListItem", "position": 2, "name": "Shop", "item": "https://inkcartridges.co.nz/html/shop.html" },
            { "@type": "ListItem", "position": 3, "name": "" }
        ]
    }
    </script>

    <!-- Schema.org Product Structured Data -->
    <script type="application/ld+json" id="product-schema">
    {
        "@context": "https://schema.org",
        "@type": "Product",
        "name": "",
        "description": "",
        "sku": "",
        "brand": {
            "@type": "Brand",
            "name": ""
        },
        "offers": {
            "@type": "Offer",
            "url": "",
            "priceCurrency": "NZD",
            "price": "",
            "availability": "https://schema.org/InStock",
            "seller": {
                "@type": "Organization",
                "name": "InkCartridges.co.nz"
            }
        }
    }
    </script>

    <!-- Google Analytics 4 (with consent mode) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SDQELG0FGD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent', 'default', {
            analytics_storage: localStorage.getItem('cookie_consent') === 'accepted' ? 'granted' : 'denied'
        });
        gtag('js', new Date());
        gtag('config', 'G-SDQELG0FGD');
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/modern-effects.css">
    <link rel="stylesheet" href="/css/pages.css">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <header class="site-header">
        <div class="header-main">
            <div class="container">
                <div class="header-contact">
                    <a href="tel:0800465275" class="header-contact__item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                        0800 INK KART (465 275)
                    </a>
                    <a href="mailto:support@inkcartridges.co.nz" class="header-contact__item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        support@inkcartridges.co.nz
                    </a>
                </div>

                <div class="logo-block">
                    <a href="/html/index.html" class="logo" aria-label="InkCartridges.co.nz Home">
                        <span class="logo__text">Ink<span>Cartridges</span>.co.nz</span>
                    </a>
                    <a href="/html/index.html" class="logo__tagline">Get the full picture on image quality</a>
                </div>

                <div class="header-actions">
                    <a href="/html/account/index.html" class="header-actions__item">
                        <span class="header-actions__icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </span>
                        <span>Account</span>
                    </a>
                    <a href="/html/account/favourites.html" class="header-actions__item">
                        <span class="header-actions__icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                        </span>
                        <span>Favourites</span>
                    </a>
                    <a href="/html/cart.html" class="header-actions__item">
                        <span class="header-actions__icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                            <span class="cart-badge" id="cart-count">0</span>
                        </span>
                        <span>Cart</span>
                    </a>
                </div>
            </div>
        </div>

        <nav class="primary-nav" aria-label="Main navigation">
            <div class="container">
                <button class="nav-toggle" aria-expanded="false" aria-controls="nav-menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    <span class="visually-hidden">Menu</span>
                </button>

                <ul id="nav-menu" class="nav-menu">
                    <li class="nav-menu__item"><a href="/html/index.html" class="nav-menu__link">Home</a></li>
                    <li class="nav-menu__item"><a href="/html/shop.html" class="nav-menu__link">Shop</a></li>
                    <li class="nav-menu__item nav-menu__item--mega">
                        <button class="nav-menu__link nav-mega-toggle" type="button"
                                aria-haspopup="true" aria-expanded="false" aria-controls="brands-mega">
                            Ink Cartridge Brands
                            <svg class="nav-menu__arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </button>
                    </li>
                    <li class="nav-menu__item"><a href="/html/ribbons.html" class="nav-menu__link">Typewriter &amp; Printer Ribbons</a></li>
                </ul>

                <form class="search-form search-form--nav" action="/html/shop.html" method="GET" role="search">
                    <label for="search-input" class="visually-hidden">Search for products</label>
                    <input type="search" id="search-input" name="q" class="search-form__input" placeholder="Search..." autocomplete="off" maxlength="200">
                    <button type="submit" class="search-form__button" aria-label="Search">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    </button>
                </form>
            </div>
        </nav>

        <!-- Brands Mega Dropdown -->
        <div class="brands-mega" id="brands-mega" hidden role="region" aria-label="Browse brands">
            <div class="container">
                <div class="brands-mega__cards"></div>
                <a href="/html/shop.html" class="brands-mega__view-all">
                    View All Brands
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                </a>
            </div>
        </div>
    </header>

    <main id="main-content" class="site-main">
        <!-- Breadcrumb -->
        <nav class="breadcrumb" aria-label="Breadcrumb">
            <div class="container">
                <ol class="breadcrumb__list" id="breadcrumb-list">
                    <li class="breadcrumb__item"><a href="/html/index.html">Home</a></li>
                    <li class="breadcrumb__item"><a href="/html/shop.html">Shop</a></li>
                    <li class="breadcrumb__item" id="breadcrumb-category"><a href="/html/shop.html">Products</a></li>
                    <li class="breadcrumb__item" id="breadcrumb-brand"><a href="/html/shop.html">Brand</a></li>
                    <li class="breadcrumb__item" id="breadcrumb-code" hidden></li>
                    <li class="breadcrumb__item breadcrumb__item--current" id="breadcrumb-product" aria-current="page">Loading...</li>
                </ol>
            </div>
        </nav>

        <!-- Product detail section -->
        <section class="product-detail">
            <div class="container">
                <div class="product-detail__layout">
                    <!-- Product gallery -->
                    <div class="product-gallery">
                        <div class="product-gallery__main" id="product-image">
                            <div class="product-gallery__image-placeholder">
                                <svg width="200" height="200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <rect x="6" y="2" width="12" height="20" rx="2"/>
                                    <path d="M9 6h6M9 10h6"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Product info -->
                    <div class="product-info">
                        <div class="product-info__header">
                            <span class="product-info__badge" id="product-badge" hidden>COMPATIBLE</span>
                            <h1 class="product-info__title" id="product-title">Loading...</h1>
                            <p class="product-info__sku" id="product-sku">SKU: Loading...</p>
                        </div>

                        <div class="product-info__pricing">
                            <span class="product-info__price" id="product-price">$0.00</span>
                        </div>
                        <p class="product-info__gst">Incl. GST | Free shipping over $100</p>

                        <div class="product-info__availability" id="product-stock">
                            <span class="stock-status stock-status--in-stock">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                In Stock
                            </span>
                        </div>

                        <div class="product-info__actions">
                            <div class="quantity-selector">
                                <button type="button" class="quantity-selector__btn" id="qty-decrease" aria-label="Decrease quantity">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                </button>
                                <input type="number" class="quantity-selector__input" id="qty-input" value="1" min="1" max="100" aria-label="Quantity">
                                <button type="button" class="quantity-selector__btn" id="qty-increase" aria-label="Increase quantity">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                </button>
                            </div>

                            <button type="button" class="btn btn--primary btn--lg product-info__add-to-cart" id="add-to-cart-btn" data-track="add_to_cart" data-track-location="product_page" data-testid="product-add-to-cart">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                                Add to Cart
                            </button>

                            <!-- Favourite button -->
                            <button type="button" class="favourite-btn" id="favourite-btn" aria-pressed="false" title="Add to favourites">
                                <svg class="favourite-btn__icon favourite-btn__icon--outline" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                                </svg>
                                <svg class="favourite-btn__icon favourite-btn__icon--filled" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                                </svg>
                                <span class="visually-hidden">Add to favourites</span>
                            </button>
                        </div>

                        <ul class="product-info__trust">
                            <li class="product-info__trust-item">
                                <svg class="product-info__trust-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                                <span>Free shipping on orders over $100</span>
                            </li>
                            <li class="product-info__trust-item">
                                <svg class="product-info__trust-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                <span>30-day hassle-free returns</span>
                            </li>
                            <li class="product-info__trust-item">
                                <svg class="product-info__trust-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                <span>Secure checkout with SSL encryption</span>
                            </li>
                        </ul>

                        <div class="product-info__features">
                            <h2 class="product-info__features-heading">Key Features</h2>
                            <ul class="feature-list" id="product-features">
                                <!-- Populated dynamically -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Need Help Banner -->
        <div class="container">
            <div class="need-help" data-track="support_impression" data-track-location="product_page">
                <svg class="need-help__icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <div class="need-help__text">
                    <strong>Need help finding your cartridge?</strong>
                    Call <a href="tel:0800465275" data-track="contact_click" data-track-type="phone" data-track-location="product_help">0800 INK KART</a> or
                    <a href="mailto:support@inkcartridges.co.nz" data-track="contact_click" data-track-type="email" data-track-location="product_help">email us</a> â€” we'll match it for you.
                </div>
            </div>
        </div>

        <!-- Product tabs -->
        <section class="product-tabs">
            <div class="container">
                <div class="tabs" role="tablist">
                    <button role="tab" aria-selected="true" aria-controls="tab-description" id="tab-btn-description" class="tabs__button tabs__button--active">Description</button>
                    <button role="tab" aria-selected="false" aria-controls="tab-specs" id="tab-btn-specs" class="tabs__button">Specifications</button>
                    <button role="tab" aria-selected="false" aria-controls="tab-faqs" id="tab-btn-faqs" class="tabs__button">FAQs</button>
                </div>

                <div class="tabs__panels">
                    <div role="tabpanel" id="tab-description" aria-labelledby="tab-btn-description" class="tabs__panel tabs__panel--active">
                        <div class="product-description" id="product-description">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <div role="tabpanel" id="tab-specs" aria-labelledby="tab-btn-specs" class="tabs__panel" hidden>
                        <table class="specs-table" id="product-specs">
                            <!-- Populated dynamically -->
                        </table>
                    </div>

                    <div role="tabpanel" id="tab-faqs" aria-labelledby="tab-btn-faqs" class="tabs__panel" hidden>
                        <div class="product-faqs" id="product-faqs">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Sticky Mobile Add-to-Cart Bar -->
    <div class="sticky-atc" id="sticky-atc" aria-hidden="true">
        <div class="sticky-atc__inner">
            <span class="sticky-atc__price" id="sticky-atc-price"></span>
            <button type="button" class="btn btn--primary sticky-atc__btn" id="sticky-atc-btn" data-track="add_to_cart" data-track-location="sticky_mobile">
                Add to Cart
            </button>
        </div>
    </div>

    <footer class="site-footer">
        <div class="footer-main">
            <div class="container">
                <div class="footer-grid">
                    <div class="footer-brand">
                        <a href="/html/index.html" class="footer-brand__logo">
                            <span class="logo__text">Ink<span>Cartridges</span>.co.nz</span>
                        </a>
                        <p class="footer-brand__description">New Zealand's trusted source for quality printing supplies.</p>
                    </div>
                    <div class="footer-column">
                        <h3 class="footer-column__heading">Shop</h3>
                        <ul class="footer-links">
                            <li><a href="/html/shop.html">Browse All Products</a></li>
                            <li><a href="/html/shop.html?brand=brother">Brother</a></li>
                            <li><a href="/html/shop.html?brand=canon">Canon</a></li>
                            <li><a href="/html/shop.html?brand=epson">Epson</a></li>
                            <li><a href="/html/shop.html?brand=hp">HP</a></li>
                            <li><a href="/html/shop.html?brand=samsung">Samsung</a></li>
                            <li><a href="/html/shop.html?brand=lexmark">Lexmark</a></li>
                            <li><a href="/html/shop.html?brand=oki">OKI</a></li>
                            <li><a href="/html/shop.html?brand=fuji-xerox">Fuji Xerox</a></li>
                            <li><a href="/html/shop.html?brand=kyocera">Kyocera</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3 class="footer-column__heading">Support</h3>
                        <ul class="footer-links">
                            <li><a href="/html/contact.html">Contact Us</a></li>
                            <li><a href="/html/faq.html">FAQs</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3 class="footer-column__heading">Contact</h3>
                        <ul class="footer-links">
                            <li><strong>Phone:</strong><br><a href="tel:0800465275">0800 INK KART (465 275)</a></li>
                            <li><strong>Email:</strong><br><a href="mailto:support@inkcartridges.co.nz">support@inkcartridges.co.nz</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="container">
                <p class="footer-copyright">&copy; 2026 InkCartridges.co.nz. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/config.js"></script>
    <script src="/js/security.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/cart.js"></script>
    <script src="/js/favourites.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/mega-nav.js"></script>
    <script src="/js/modern-effects.js"></script>

    <script>
    // ============================================
    // DYNAMIC PRODUCT PAGE
    // ============================================
    const ProductPage = {
        product: null,

        // Delegate to shared ProductColors utility
        getColorStyle(colorName) {
            return ProductColors.getStyle(colorName);
        },

        detectColorFromName(name) {
            return ProductColors.detectFromName(name);
        },

        // Product type templates for descriptions
        templates: {
            toner: {
                description: (p) => `
                    <div class="product-details-section">
                        <p class="product-details-meta">
                            <strong>Model:</strong> ${Security.escapeHtml(p.manufacturer_part_number || p.sku)}
                            <span style="margin-left: 1.5rem;"><strong>SKU:</strong> ${Security.escapeHtml(p.sku)}</span>
                        </p>
                        <p class="product-details-intro">
                            ${p.isCompatible
                                ? `Premium quality compatible toner for your ${Security.escapeHtml(p.brandName)} printer. Our compatible toner cartridges deliver professional-quality documents with impressive reliability and page yields at a fraction of the cost of genuine cartridges.`
                                : `Count on professional-quality documents with dependable performance. Original ${Security.escapeHtml(p.brandName)} toner cartridges provide impressive reliability for dependable performance and page yields, and durable results.`
                            }
                        </p>
                    </div>

                    <h3 class="product-details-heading">Features & Benefits</h3>
                    <ul class="product-features-list">
                        ${p.pageYield ? `<li><strong>Page Yield:</strong> ${p.pageYield.toLocaleString()} pages</li>` : ''}
                        <li>Page yield based on 5% coverage of an A4 page</li>
                        ${p.color ? `<li><strong>Colour:</strong> ${Security.escapeHtml(p.color)} toner</li>` : ''}
                        <li>${p.isCompatible ? 'Compatible with' : 'Designed for'} ${Security.escapeHtml(p.brandName)} laser printers</li>
                        <li>Easy installation - simply remove and replace</li>
                        <li>${p.isCompatible ? 'ISO 9001 certified manufacturing' : '12 months manufacturer warranty'}</li>
                        ${p.isCompatible ? '<li>Tested to meet or exceed OEM specifications</li>' : '<li>Genuine OEM product for optimal reliability</li>'}
                    </ul>

                    <h3 class="product-details-heading">What's Included</h3>
                    <ul class="product-features-list">
                        <li>1 x ${Security.escapeHtml(p.displayName)}</li>
                        <li>Installation guide</li>
                    </ul>
                `,
                features: (p) => [
                    p.pageYield ? `Page yield: ~${p.pageYield.toLocaleString()} pages (5% coverage)` : 'High-quality output',
                    `${p.isCompatible ? 'Compatible' : 'Genuine OEM'} ${Security.escapeHtml(p.brandName)} toner`,
                    'Sharp, professional text and graphics',
                    'Easy snap-in installation',
                    p.color ? `Colour: ${Security.escapeHtml(p.color)}` : null,
                    p.isCompatible ? 'ISO 9001 certified quality' : '12 month warranty'
                ].filter(Boolean),
                faqs: (p) => [
                    {
                        q: 'How do I install this toner cartridge?',
                        a: `<p>Installing your ${Security.escapeHtml(p.brandName)} toner is straightforward:</p>
                            <ol>
                                <li>Turn off and unplug your printer</li>
                                <li>Open the front or top cover to access the toner compartment</li>
                                <li>Remove the old toner cartridge</li>
                                <li>Unpack the new toner and gently shake it side-to-side to distribute the toner evenly</li>
                                <li>Remove any protective covers or sealing tape</li>
                                <li>Insert the new cartridge until it clicks into place</li>
                                <li>Close the cover and turn on your printer</li>
                            </ol>`
                    },
                    {
                        q: 'How should I store unused toner cartridges?',
                        a: `<p>Store unopened toner cartridges in their original packaging in a cool, dry place away from direct sunlight. Avoid extreme temperatures and humidity. Properly stored toner cartridges typically have a shelf life of 2-3 years.</p>`
                    },
                    {
                        q: p.isCompatible ? 'Are compatible toners safe for my printer?' : 'Why is genuine toner more expensive?',
                        a: p.isCompatible
                            ? `<p>Yes, our compatible toner cartridges are designed and tested to work safely with your printer. Under New Zealand consumer law, using compatible consumables does not void your printer warranty. Our cartridges meet strict quality standards and come with our satisfaction guarantee.</p>`
                            : `<p>Genuine ${Security.escapeHtml(p.brandName)} toner cartridges are manufactured to exact specifications using premium materials and undergo rigorous quality testing. They're optimised for your specific printer model to deliver the best possible print quality and reliability while protecting your printer's longevity.</p>`
                    }
                ]
            },
            ink: {
                description: (p) => `
                    <div class="product-details-section">
                        <p class="product-details-meta">
                            <strong>Model:</strong> ${Security.escapeHtml(p.manufacturer_part_number || p.sku)}
                            <span style="margin-left: 1.5rem;"><strong>SKU:</strong> ${Security.escapeHtml(p.sku)}</span>
                        </p>
                        <p class="product-details-intro">
                            ${p.isCompatible
                                ? `Premium quality compatible ink for your ${Security.escapeHtml(p.brandName)} printer. Our compatible ink cartridges deliver vibrant colours and crisp text with reliable performance at a fraction of the cost of genuine cartridges.`
                                : `Count on professional-quality vibrant colour documents. Original ${Security.escapeHtml(p.brandName)} ink cartridges provide impressive reliability for dependable performance and page yields, and durable results. Print with individual inks and high-yield cartridge options.`
                            }
                        </p>
                    </div>

                    <h3 class="product-details-heading">Features & Benefits</h3>
                    <ul class="product-features-list">
                        ${p.pageYield ? `<li><strong>Page Yield:</strong> ${p.pageYield.toLocaleString()} pages</li>` : ''}
                        <li>Page yield based on 5% coverage of an A4 page</li>
                        ${p.color ? `<li><strong>Colour:</strong> ${Security.escapeHtml(p.color)} ink cartridge</li>` : ''}
                        <li>${p.isCompatible ? 'Compatible with' : 'Designed for'} ${Security.escapeHtml(p.brandName)} inkjet printers</li>
                        <li>Vibrant colours and sharp black text</li>
                        <li>Easy snap-in installation</li>
                        ${p.isCompatible ? '<li>Premium ink formulation tested for quality</li>' : '<li>12 months manufacturer warranty</li>'}
                        ${!p.isCompatible ? '<li>Smudge-resistant and water-resistant prints</li>' : '<li>Excellent value alternative to genuine</li>'}
                    </ul>

                    <h3 class="product-details-heading">What's Included</h3>
                    <ul class="product-features-list">
                        <li>1 x ${Security.escapeHtml(p.displayName)}</li>
                        <li>Installation guide</li>
                    </ul>
                `,
                features: (p) => [
                    p.pageYield ? `Page yield: ~${p.pageYield.toLocaleString()} pages (5% coverage)` : 'Reliable print quality',
                    `${p.isCompatible ? 'Compatible' : 'Genuine OEM'} ${Security.escapeHtml(p.brandName)} ink`,
                    'Vibrant colours and sharp text',
                    'Easy snap-in installation',
                    p.color ? `Colour: ${Security.escapeHtml(p.color)}` : null,
                    p.isCompatible ? 'Premium ink quality' : '12 month warranty'
                ].filter(Boolean),
                faqs: (p) => [
                    {
                        q: 'How do I install this ink cartridge?',
                        a: `<p>Installing your ink cartridge is simple:</p>
                            <ol>
                                <li>Turn on your printer and open the ink cartridge access door</li>
                                <li>Wait for the carriage to move to the centre</li>
                                <li>Press down on the old cartridge and remove it</li>
                                <li>Remove the new cartridge from packaging and pull off any protective tape</li>
                                <li>Insert the new cartridge into the correct slot until it clicks</li>
                                <li>Close the access door and print an alignment page if prompted</li>
                            </ol>`
                    },
                    {
                        q: 'How long do ink cartridges last?',
                        a: `<p>Unopened ink cartridges typically have a shelf life of 1-2 years when stored properly. Once installed, we recommend using the cartridge within 6 months for best results. Print regularly (at least once a week) to prevent the print heads from drying out.</p>`
                    },
                    {
                        q: p.isCompatible ? 'Will compatible ink void my warranty?' : 'Can I use compatible cartridges in my printer?',
                        a: p.isCompatible
                            ? `<p>Under New Zealand consumer law, using compatible (third-party) cartridges does not automatically void your printer warranty. However, if a compatible cartridge directly causes damage, that specific damage may not be covered. Our compatible cartridges are designed to work safely with your printer.</p>`
                            : `<p>While you can use compatible cartridges, genuine ${Security.escapeHtml(p.brandName)} ink is designed specifically for your printer model. Genuine supplies ensure optimal print quality, reliability, and are backed by ${Security.escapeHtml(p.brandName)}'s quality guarantee.</p>`
                    }
                ]
            },
            drum: {
                description: (p) => `
                    <div class="product-details-section">
                        <p class="product-details-meta">
                            <strong>Model:</strong> ${Security.escapeHtml(p.manufacturer_part_number || p.sku)}
                            <span style="margin-left: 1.5rem;"><strong>SKU:</strong> ${Security.escapeHtml(p.sku)}</span>
                        </p>
                        <p class="product-details-intro">
                            ${p.isCompatible
                                ? `Quality compatible drum unit for your ${Security.escapeHtml(p.brandName)} laser printer. The drum unit is an essential component responsible for transferring toner to paper, ensuring consistent high-quality prints.`
                                : `Original ${Security.escapeHtml(p.brandName)} drum unit for optimal print quality and reliability. The imaging drum is engineered to work perfectly with your printer for consistent, professional results.`
                            }
                        </p>
                    </div>

                    <h3 class="product-details-heading">Features & Benefits</h3>
                    <ul class="product-features-list">
                        ${p.pageYield ? `<li><strong>Drum Yield:</strong> ${p.pageYield.toLocaleString()} pages</li>` : '<li>Long-lasting drum life</li>'}
                        <li>Drum yield based on 1 page per job</li>
                        <li>${p.isCompatible ? 'Compatible with' : 'Designed for'} ${Security.escapeHtml(p.brandName)} laser printers</li>
                        <li>Consistent, high-quality print output</li>
                        <li>Easy installation process</li>
                        <li>Separate from toner cartridge - longer lifespan</li>
                        ${p.isCompatible ? '<li>Tested to OEM specifications</li>' : '<li>12 months manufacturer warranty</li>'}
                    </ul>

                    <h3 class="product-details-heading">When to Replace</h3>
                    <p>Replace your drum unit when you notice persistent print quality issues such as vertical lines, spots, or grey backgrounds that don't improve after replacing the toner cartridge.</p>

                    <h3 class="product-details-heading">What's Included</h3>
                    <ul class="product-features-list">
                        <li>1 x ${Security.escapeHtml(p.displayName)}</li>
                        <li>Installation instructions</li>
                    </ul>
                `,
                features: (p) => [
                    p.pageYield ? `Drum yield: ~${p.pageYield.toLocaleString()} pages` : 'Long-lasting performance',
                    `${p.isCompatible ? 'Compatible' : 'Genuine OEM'} ${Security.escapeHtml(p.brandName)} drum`,
                    'Consistent print quality',
                    'Easy installation',
                    p.isCompatible ? 'Tested to OEM specs' : '12 month warranty'
                ],
                faqs: (p) => [
                    {
                        q: 'What is a drum unit and when should I replace it?',
                        a: `<p>The drum unit (also called an imaging drum) is a cylinder that transfers toner onto paper. It typically lasts 3-4 times longer than a toner cartridge. Replace the drum when you notice persistent print quality issues like vertical lines, spots, or grey backgrounds that don't improve after replacing the toner.</p>`
                    },
                    {
                        q: 'Is the drum unit the same as the toner?',
                        a: `<p>No, they're different components. The toner cartridge contains the powder that creates the printed image, while the drum unit is the component that transfers the toner to paper. Some printers have them combined in one unit, but many ${Security.escapeHtml(p.brandName)} printers use separate drum and toner units for cost efficiency.</p>`
                    }
                ]
            },
            default: {
                description: (p) => `
                    <div class="product-details-section">
                        <p class="product-details-meta">
                            <strong>Model:</strong> ${Security.escapeHtml(p.manufacturer_part_number || p.sku)}
                            <span style="margin-left: 1.5rem;"><strong>SKU:</strong> ${Security.escapeHtml(p.sku)}</span>
                        </p>
                        <p class="product-details-intro">
                            Quality ${Security.escapeHtml(p.brandName)} printing supplies for your printer. ${p.isCompatible ? 'This compatible product offers excellent value while maintaining high quality standards.' : 'Genuine OEM product for optimal performance and reliability.'}
                        </p>
                    </div>

                    <h3 class="product-details-heading">Features & Benefits</h3>
                    <ul class="product-features-list">
                        ${p.pageYield ? `<li><strong>Page Yield:</strong> ${p.pageYield.toLocaleString()} pages</li>` : ''}
                        <li>${p.isCompatible ? 'Compatible' : 'Genuine'} ${Security.escapeHtml(p.brandName)} product</li>
                        <li>High quality printing results</li>
                        <li>Easy installation</li>
                        ${p.isCompatible ? '<li>Cost-effective alternative</li>' : '<li>Manufacturer warranty included</li>'}
                    </ul>

                    <h3 class="product-details-heading">What's Included</h3>
                    <ul class="product-features-list">
                        <li>1 x ${Security.escapeHtml(p.displayName)}</li>
                    </ul>
                `,
                features: (p) => [
                    `${p.isCompatible ? 'Compatible' : 'Genuine'} ${Security.escapeHtml(p.brandName)} product`,
                    'Quality assured',
                    'Easy installation',
                    p.pageYield ? `Page yield: ~${p.pageYield.toLocaleString()} pages` : null
                ].filter(Boolean),
                faqs: (p) => [
                    {
                        q: 'How do I know this product is compatible with my printer?',
                        a: `<p>Check your printer's documentation or the label inside the cartridge access door for the model number. This product is designed to work with specific ${Security.escapeHtml(p.brandName)} printer models. If you're unsure, contact our customer support for assistance.</p>`
                    }
                ]
            }
        },

        async init() {
            const params = new URLSearchParams(window.location.search);
            const sku = params.get('sku');

            if (!sku) {
                this.showError('No product specified');
                return;
            }

            try {
                const response = await API.getProduct(sku);
                if (!response.success || !response.data) {
                    this.showError('Product not found');
                    return;
                }

                this.product = response.data;
                this.renderProduct();
            } catch (error) {
                console.error('Error loading product:', error);
                this.showError('Failed to load product');
            }
        },

        getProductInfo() {
            const p = this.product;
            const name = p.name || '';
            const isCompatible = name.toLowerCase().startsWith('compatible ');
            const displayName = isCompatible ? name.substring(11).trim() : name;
            const brandName = p.brand?.name || this.extractBrand(name) || 'Unknown';
            const category = p.category || this.detectCategory(name);
            const pageYield = p.page_yield || p.yield || null;

            return {
                ...p,
                isCompatible,
                displayName,
                brandName,
                category,
                pageYield,
                color: p.color || null
            };
        },

        extractBrand(name) {
            const brands = ['Brother', 'Canon', 'Epson', 'HP', 'Samsung'];
            for (const brand of brands) {
                if (name.toLowerCase().includes(brand.toLowerCase())) {
                    return brand;
                }
            }
            return null;
        },

        detectCategory(name) {
            const lower = name.toLowerCase();
            if (lower.includes('toner')) return 'toner';
            if (lower.includes('drum')) return 'drum';
            if (lower.includes('ink') || lower.includes('cartridge')) return 'ink';
            return 'default';
        },

        /**
         * Extract the primary product code (e.g., "LC37") from product name/MPN
         */
        extractProductCode(info) {
            const brand = (info.brandName || '').toLowerCase();
            const patterns = {
                brother: /\b(LC[-]?\d{2,5}(?:XL)?|TN[-]?\d{3,4}|DR[-]?\d{3,4})\b/i,
                canon: /\b((?:PG|CL|PGI|CLI)[-]?\d{2,4}(?:XL)?)\b/i,
                epson: /\b(T\d{2,4}(?:XL)?|C13T\d+)\b/i,
                hp: /\b(\d{2,3}(?:XL)?[AX]?|CF\d{3}[AX]?|CE\d{3}[AX]?|W\d{4}[AX]?)\b/i,
                samsung: /\b((?:MLT[-]?D|CLT[-]?[CKMY])\d{3}[SL]?)\b/i,
                oki: /\b(C\d{3,4}|B\d{3,4})\b/i,
                'fuji-xerox': /\b(CT\d{6}|CWAA\d{4})\b/i,
                kyocera: /\b(TK[-]?\d{3,4}|DK[-]?\d{3,4})\b/i,
                lexmark: /\b(\d{2}[A-Z]\d{3,6}[A-Z]?)\b/i
            };

            const pattern = patterns[brand] || patterns[brand.replace(/[\s-]/g, '')] ||
                /\b[A-Z]{1,3}[-]?\d{2,4}(?:XL)?\b/i;

            // Try manufacturer_part_number first, then product name (without brand prefix)
            const nameWithoutPrefix = (info.name || '').replace(/^(Compatible\s+)?/i, '').replace(new RegExp('^' + info.brandName + '\\s+', 'i'), '');
            const sources = [info.manufacturer_part_number, nameWithoutPrefix, info.name];

            for (const source of sources) {
                if (!source) continue;
                const match = source.match(pattern);
                if (match) {
                    // Normalize: remove dashes, uppercase
                    return match[1] ? match[1].replace(/-/g, '').toUpperCase() : match[0].replace(/-/g, '').toUpperCase();
                }
            }
            return null;
        },

        renderProduct() {
            const info = this.getProductInfo();
            const price = parseFloat(info.retail_price || 0);
            const currentUrl = window.location.href;

            // Page title and meta description
            const metaDescription = this.generateMetaDescription(info);
            document.title = `${info.displayName} | Buy Online NZ | InkCartridges.co.nz`;
            document.getElementById('meta-description').content = metaDescription;

            // Open Graph tags
            document.getElementById('og-title').content = `${info.displayName} | InkCartridges.co.nz`;
            document.getElementById('og-description').content = metaDescription;
            document.getElementById('og-url').content = currentUrl;
            document.getElementById('og-price').content = price.toFixed(2);
            if (info.image_url) {
                document.getElementById('og-image').content = info.image_url;
            }

            // Twitter tags
            document.getElementById('twitter-title').content = `${info.displayName} | InkCartridges.co.nz`;
            document.getElementById('twitter-description').content = metaDescription;
            if (info.image_url) {
                document.getElementById('twitter-image').content = info.image_url;
            }

            // Canonical URL
            document.getElementById('canonical-url').href = currentUrl;

            // Schema.org Product structured data
            this.updateProductSchema(info, price);

            // Breadcrumb
            const categoryName = info.category === 'toner' ? 'Toner Cartridges' :
                                 info.category === 'drum' ? 'Drums' : 'Ink Cartridges';
            const brandSlug = info.brandName.toLowerCase().replace(/\s+/g, '-');
            document.getElementById('breadcrumb-category').innerHTML = `<a href="/html/shop.html?brand=${Security.escapeAttr(brandSlug)}&category=${Security.escapeAttr(info.category)}">${Security.escapeHtml(categoryName)}</a>`;
            document.getElementById('breadcrumb-brand').innerHTML = `<a href="/html/shop.html?brand=${Security.escapeAttr(brandSlug)}">${Security.escapeHtml(info.brandName)}</a>`;

            // Add product code breadcrumb (e.g., LC37)
            const productCode = this.extractProductCode(info);
            const breadcrumbCode = document.getElementById('breadcrumb-code');
            if (productCode && breadcrumbCode) {
                breadcrumbCode.innerHTML = `<a href="/html/shop.html?brand=${Security.escapeAttr(brandSlug)}&category=${Security.escapeAttr(info.category)}&code=${Security.escapeAttr(productCode)}">${Security.escapeHtml(productCode)}</a>`;
                breadcrumbCode.hidden = false;
            }

            document.getElementById('breadcrumb-product').textContent = info.displayName;

            // Product badge
            const badge = document.getElementById('product-badge');
            if (info.isCompatible) {
                badge.textContent = 'COMPATIBLE';
                badge.hidden = false;
            }

            // Title and SKU
            document.getElementById('product-title').textContent = info.displayName;
            document.getElementById('product-sku').textContent = `SKU: ${info.sku}${info.manufacturer_part_number ? ' | Model: ' + info.manufacturer_part_number : ''}`;

            // Price - use formatPrice() for consistent locale-aware currency display
            document.getElementById('product-price').textContent = formatPrice(price);

            // Stock status
            const stockEl = document.getElementById('product-stock');
            if (info.in_stock) {
                stockEl.innerHTML = `<span class="stock-status stock-status--in-stock">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    In Stock
                </span>`;
            } else {
                stockEl.innerHTML = `<span class="stock-status stock-status--out-of-stock">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/></svg>
                    Out of Stock
                </span>`;
                document.getElementById('add-to-cart-btn').disabled = true;
            }

            // Product image with color fallback
            const productImageEl = document.getElementById('product-image');
            if (info.image_url) {
                const color = info.color || this.detectColorFromName(info.displayName);
                const colorStyle = color ? this.getColorStyle(color) : null;

                if (colorStyle) {
                    // Image with color fallback on error
                    productImageEl.innerHTML = `
                        <img src="${Security.escapeAttr(Security.sanitizeUrl(info.image_url))}" alt="${Security.escapeAttr(info.displayName)}" style="max-width: 100%; height: auto;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="product-gallery__color-block" style="${colorStyle}; display: none;"></div>`;
                } else {
                    // Image with placeholder fallback
                    productImageEl.innerHTML = `<img src="${Security.escapeAttr(Security.sanitizeUrl(info.image_url))}" alt="${Security.escapeAttr(info.displayName)}" style="max-width: 100%; height: auto;"
                        onerror="this.onerror=null; this.src='/assets/images/placeholder-product.svg';">`;
                }
            } else {
                // No image - show color block or placeholder
                const color = info.color || this.detectColorFromName(info.displayName);
                const colorStyle = color ? this.getColorStyle(color) : null;

                if (colorStyle) {
                    // colorStyle is safe â€” sourced from hardcoded ProductColors.map
                    productImageEl.classList.add('product-gallery__main--color-only');
                    productImageEl.closest('.product-detail__layout').classList.add('product-detail__layout--color-only');
                    productImageEl.innerHTML = `<div class="product-gallery__color-block" style="${colorStyle}"></div>`;
                } else {
                    productImageEl.innerHTML = `<img src="/assets/images/placeholder-product.svg" alt="${Security.escapeAttr(info.displayName)}" style="max-width: 100%; height: auto;">`;
                }
            }

            // Get template based on category
            const template = this.templates[info.category] || this.templates.default;

            // Features
            const features = template.features(info);
            document.getElementById('product-features').innerHTML = features.map(f => `
                <li>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    ${Security.escapeHtml(f)}
                </li>
            `).join('');

            // Description
            document.getElementById('product-description').innerHTML = template.description(info);

            // Specifications
            document.getElementById('product-specs').innerHTML = `
                <tbody>
                    <tr><th scope="row">Brand</th><td>${Security.escapeHtml(info.brandName)}</td></tr>
                    <tr><th scope="row">SKU</th><td>${Security.escapeHtml(info.sku)}</td></tr>
                    ${info.manufacturer_part_number ? `<tr><th scope="row">Model Number</th><td>${Security.escapeHtml(info.manufacturer_part_number)}</td></tr>` : ''}
                    ${info.color ? `<tr><th scope="row">Colour</th><td>${Security.escapeHtml(info.color)}</td></tr>` : ''}
                    ${info.pageYield ? `<tr><th scope="row">Page Yield</th><td>Approx. ${info.pageYield.toLocaleString()} pages</td></tr>` : ''}
                    <tr><th scope="row">Product Type</th><td>${info.isCompatible ? 'Compatible' : 'Genuine OEM'}</td></tr>
                    <tr><th scope="row">Category</th><td>${Security.escapeHtml(categoryName)}</td></tr>
                </tbody>
            `;

            // FAQs
            const faqs = template.faqs(info);
            // faq.q is plain text â€” escape it. faq.a is trusted HTML from templates
            // (dynamic values inside faq.a are already escaped at the template level above).
            document.getElementById('product-faqs').innerHTML = faqs.map(faq => `
                <details class="faq-item">
                    <summary class="faq-item__question">${Security.escapeHtml(faq.q)}</summary>
                    <div class="faq-item__answer">${faq.a}</div>
                </details>
            `).join('') || '<p>No FAQs available for this product.</p>';

            // Compatible Printers
            this.renderCompatiblePrinters(info);

            // Set up event listeners
            this.setupEventListeners(info);
        },

        async renderCompatiblePrinters(info) {
            const descriptionEl = document.getElementById('product-description');
            if (!descriptionEl) return;

            try {
                // Try current product SKU first
                let printers = await this._fetchPrinters(info.sku);

                // If empty, find a sibling product that has printer data
                // (compatible products often lack it, but genuine ones have it)
                if (printers.length === 0) {
                    const code = this.extractProductCode(info);
                    if (code) {
                        const searchResponse = await API.getProducts({
                            brand: (info.brand?.slug || info.brandName || '').toLowerCase().replace(/\s+/g, '-'),
                            search: code,
                            limit: 10
                        });
                        if (searchResponse.success && searchResponse.data?.products) {
                            for (const product of searchResponse.data.products) {
                                if (product.sku && product.sku !== info.sku) {
                                    printers = await this._fetchPrinters(product.sku);
                                    if (printers.length > 0) break;
                                }
                            }
                        }
                    }
                }

                if (printers.length === 0) return;

                const printerLinks = printers.map(p => {
                    const params = new URLSearchParams({ printer_model: p.name });
                    if (p.brand) params.set('printer_brand', p.brand);
                    return `<a href="/html/shop.html?${params}" class="printer-link">${Security.escapeHtml(p.name)}</a>`;
                }).join(', ');

                const html = `
                    <div class="product-printers-banner" style="margin-top: var(--spacing-xl);">
                        <strong>For Use In:</strong>
                        <span>${printerLinks}</span>
                    </div>
                `;

                descriptionEl.insertAdjacentHTML('beforeend', html);
            } catch (error) {
                // Silently fail â€” compatible printers are optional
            }
        },

        /**
         * Fetch printer names for a given SKU from the compatible-printers endpoint
         */
        async _fetchPrinters(sku) {
            try {
                const response = await API.getCompatiblePrinters(sku);
                if (!response.success || !response.data) return [];

                const printers = response.data.printers || response.data.compatible_printers || response.data;
                if (!Array.isArray(printers) || printers.length === 0) return [];

                return printers.map(p => {
                    if (typeof p === 'string') return { name: p, brand: '' };
                    const name = p.full_name || p.model_name || p.name || '';
                    const brand = p.brand_name || p.brand || '';
                    return { name, brand };
                }).filter(p => p.name).sort((a, b) => a.name.localeCompare(b.name));
            } catch (e) {
                return [];
            }
        },

        setupEventListeners(info) {
            // Quantity controls
            const qtyInput = document.getElementById('qty-input');
            document.getElementById('qty-decrease').addEventListener('click', () => {
                if (qtyInput.value > 1) qtyInput.value = parseInt(qtyInput.value) - 1;
            });
            document.getElementById('qty-increase').addEventListener('click', () => {
                if (qtyInput.value < 99) qtyInput.value = parseInt(qtyInput.value) + 1;
            });

            // Add to cart using Cart.addItem (server-first for authenticated users)
            document.getElementById('add-to-cart-btn').addEventListener('click', async () => {
                const btn = document.getElementById('add-to-cart-btn');
                const qty = parseInt(qtyInput.value) || 1;

                btn.disabled = true;
                btn.textContent = 'Adding...';

                try {
                    await Cart.addItem({
                        id: info.id,
                        name: info.name,
                        price: info.retail_price || 0,
                        sku: info.sku || '',
                        image: info.image_url || '',
                        brand: info.brandName || '',
                        quantity: qty
                    });
                    btn.textContent = 'Added!';
                    setTimeout(() => {
                        btn.textContent = 'Add to Cart';
                        btn.disabled = false;
                    }, 1500);
                } catch (error) {
                    btn.textContent = 'Error';
                    setTimeout(() => {
                        btn.textContent = 'Add to Cart';
                        btn.disabled = !info.in_stock;
                    }, 1500);
                }
            });

            // Favourite button setup
            const favBtn = document.getElementById('favourite-btn');
            if (favBtn && typeof Favourites !== 'undefined') {
                // Set data attributes
                favBtn.dataset.productId = info.id;
                favBtn.dataset.productSku = info.sku || '';
                favBtn.dataset.productName = info.displayName || info.name;
                favBtn.dataset.productPrice = info.retail_price || 0;
                favBtn.dataset.productImage = info.image_url || '';
                favBtn.dataset.productBrand = info.brandName || '';
                favBtn.dataset.productColor = info.color || '';

                // Set initial state
                const isFav = Favourites.isFavourite(info.id);
                Favourites.updateButtonState(favBtn, isFav);
            }

            // Tab switching
            document.querySelectorAll('.tabs__button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tabs__button').forEach(b => {
                        b.classList.remove('tabs__button--active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    document.querySelectorAll('.tabs__panel').forEach(p => {
                        p.classList.remove('tabs__panel--active');
                        p.hidden = true;
                    });

                    btn.classList.add('tabs__button--active');
                    btn.setAttribute('aria-selected', 'true');
                    const panel = document.getElementById(btn.getAttribute('aria-controls'));
                    panel.classList.add('tabs__panel--active');
                    panel.hidden = false;
                });
            });
        },

        // Generate SEO-friendly meta description
        generateMetaDescription(info) {
            const parts = [];

            // Product type
            if (info.isCompatible) {
                parts.push(`Compatible ${info.brandName}`);
            } else {
                parts.push(`Genuine ${info.brandName}`);
            }

            // Category
            const categoryNames = {
                'toner': 'toner cartridge',
                'ink': 'ink cartridge',
                'drum': 'drum unit'
            };
            parts.push(categoryNames[info.category] || 'printing supply');

            // Color if available
            if (info.color) {
                parts.push(`- ${info.color}`);
            }

            // Page yield if available
            if (info.pageYield) {
                parts.push(`- ${info.pageYield.toLocaleString()} page yield`);
            }

            // Price
            const price = parseFloat(info.retail_price || 0);
            parts.push(`- $${price.toFixed(2)} NZD`);

            // Call to action
            parts.push('- Free NZ shipping over $100. Fast delivery. Quality guaranteed.');

            return parts.join(' ');
        },

        // Update Schema.org Product structured data
        updateProductSchema(info, price) {
            const schema = {
                "@context": "https://schema.org",
                "@type": "Product",
                "name": info.displayName,
                "description": this.generateMetaDescription(info),
                "sku": info.sku,
                "mpn": info.manufacturer_part_number || info.sku,
                "brand": {
                    "@type": "Brand",
                    "name": info.brandName
                },
                "category": info.category === 'toner' ? 'Toner Cartridges' :
                           info.category === 'drum' ? 'Drum Units' : 'Ink Cartridges',
                "offers": {
                    "@type": "Offer",
                    "url": window.location.href,
                    "priceCurrency": "NZD",
                    "price": price.toFixed(2),
                    "availability": info.in_stock ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
                    "seller": {
                        "@type": "Organization",
                        "name": "InkCartridges.co.nz"
                    },
                    "shippingDetails": {
                        "@type": "OfferShippingDetails",
                        "shippingDestination": {
                            "@type": "DefinedRegion",
                            "addressCountry": "NZ"
                        },
                        "deliveryTime": {
                            "@type": "ShippingDeliveryTime",
                            "handlingTime": {
                                "@type": "QuantitativeValue",
                                "minValue": 0,
                                "maxValue": 1,
                                "unitCode": "DAY"
                            },
                            "transitTime": {
                                "@type": "QuantitativeValue",
                                "minValue": 1,
                                "maxValue": 5,
                                "unitCode": "DAY"
                            }
                        }
                    }
                }
            };

            // Add image if available
            if (info.image_url) {
                schema.image = info.image_url;
            }

            // Add color if available
            if (info.color) {
                schema.color = info.color;
            }

            // Update the script tag
            const schemaEl = document.getElementById('product-schema');
            if (schemaEl) {
                schemaEl.textContent = JSON.stringify(schema, null, 2);
            }
        },

        showError(message) {
            // Update title
            document.getElementById('product-title').textContent = message;
            document.getElementById('product-sku').textContent = '';
            document.getElementById('product-price').textContent = '';

            // Hide unnecessary sections
            document.querySelector('.product-info__gst').hidden = true;
            document.getElementById('product-stock').hidden = true;
            document.querySelector('.product-info__actions').hidden = true;
            document.querySelector('.product-info__trust').hidden = true;
            document.querySelector('.product-info__features').hidden = true;
            document.querySelector('.product-tabs').hidden = true;

            // Show error state in image area with retry button
            const imageEl = document.getElementById('product-image');
            imageEl.innerHTML = `
                <div class="product-error">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <p>${Security.escapeHtml(message)}</p>
                    <button class="btn btn--secondary" onclick="location.reload()">Try Again</button>
                    <a href="/html/shop.html" class="btn btn--outline">Browse All Products</a>
                </div>
            `;

            // Update breadcrumb
            document.getElementById('breadcrumb-product').textContent = 'Error';
        }
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => ProductPage.init());

    // Sticky mobile Add-to-Cart bar
    document.addEventListener('DOMContentLoaded', () => {
        const mainBtn = document.getElementById('add-to-cart-btn');
        const stickyBar = document.getElementById('sticky-atc');
        const stickyBtn = document.getElementById('sticky-atc-btn');
        const stickyPrice = document.getElementById('sticky-atc-price');
        if (!mainBtn || !stickyBar) return;

        // Show/hide based on main button visibility
        const observer = new IntersectionObserver(([entry]) => {
            if (entry.isIntersecting) {
                stickyBar.classList.remove('is-visible');
                stickyBar.setAttribute('aria-hidden', 'true');
            } else {
                stickyBar.classList.add('is-visible');
                stickyBar.setAttribute('aria-hidden', 'false');
            }
        }, { threshold: 0 });
        observer.observe(mainBtn);

        // Mirror price from product info
        const priceEl = document.getElementById('product-price');
        if (priceEl && stickyPrice) {
            new MutationObserver(() => {
                stickyPrice.textContent = priceEl.textContent;
            }).observe(priceEl, { childList: true, characterData: true, subtree: true });
            stickyPrice.textContent = priceEl.textContent;
        }

        // Trigger same click as main Add to Cart
        if (stickyBtn) {
            stickyBtn.addEventListener('click', () => mainBtn.click());
        }
    });
    </script>
    <script src="/js/analytics.js"></script>
</body>
</html>
