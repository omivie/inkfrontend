<!DOCTYPE html>
<html lang="en-NZ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Financial Health - InkCartridges.co.nz Admin">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
    <title>Financial Health | InkCartridges.co.nz Admin</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/modern-effects.css">
    <link rel="stylesheet" href="/css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        .admin-page-content { padding: var(--spacing-6); width: 100%; box-sizing: border-box; }
        .admin-chart__period { display: flex; gap: var(--spacing-2); }
        .admin-chart__period-btn { padding: var(--spacing-2) var(--spacing-3); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-background); font-size: var(--font-size-sm); cursor: pointer; transition: all 0.15s ease; }
        .admin-chart__period-btn:hover { background: var(--color-background-alt); }
        .admin-chart__period-btn--active { background: var(--cyan-primary); color: white; border-color: var(--cyan-primary); }

        /* Alert Banner */
        .alert-banner { padding: var(--spacing-4); border-radius: var(--radius-lg); margin-bottom: var(--spacing-6); display: flex; align-items: center; gap: var(--spacing-4); }
        .alert-banner--warning { background: var(--yellow-light); border: 1px solid var(--yellow-primary); }
        .alert-banner--critical { background: var(--magenta-light); border: 1px solid var(--magenta-primary); }
        .alert-banner--success { background: #D1FAE5; border: 1px solid #10b981; }
        .alert-banner__icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .alert-banner--warning .alert-banner__icon { background: var(--yellow-primary); color: white; }
        .alert-banner--critical .alert-banner__icon { background: var(--magenta-primary); color: white; }
        .alert-banner--success .alert-banner__icon { background: #10b981; color: white; }
        .alert-banner__content { flex: 1; }
        .alert-banner__title { font-weight: var(--font-weight-semibold); margin-bottom: 4px; }
        .alert-banner__text { font-size: var(--font-size-sm); opacity: 0.8; }

        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-5); margin-bottom: var(--spacing-6); }
        .kpi-card { background: var(--color-background); border-radius: var(--radius-lg); border: 1px solid var(--color-border); padding: var(--spacing-5); }
        .kpi-card--highlight { border-color: var(--cyan-primary); border-width: 2px; }
        .kpi-card__header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-3); }
        .kpi-card__icon { width: 44px; height: 44px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; }
        .kpi-card__icon--cash { background: #DBEAFE; color: #2563EB; }
        .kpi-card__icon--profit { background: #D1FAE5; color: #059669; }
        .kpi-card__icon--burn { background: var(--magenta-light); color: var(--magenta-primary); }
        .kpi-card__icon--runway { background: var(--yellow-light); color: var(--yellow-dark); }
        .kpi-card__trend { font-size: var(--font-size-xs); font-weight: var(--font-weight-medium); display: flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: var(--radius-full); }
        .kpi-card__trend--up { background: #D1FAE5; color: #059669; }
        .kpi-card__trend--down { background: var(--magenta-light); color: var(--magenta-primary); }
        .kpi-card__trend--neutral { background: var(--color-background-alt); color: var(--color-text-muted); }
        .kpi-card__value { font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); margin-bottom: var(--spacing-1); }
        .kpi-card__label { font-size: var(--font-size-sm); color: var(--color-text-muted); }
        .kpi-card__sublabel { font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--spacing-2); }

        /* Chart Grid */
        .chart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-6); margin-bottom: var(--spacing-6); }
        .chart-card { background: var(--color-background); border-radius: var(--radius-lg); border: 1px solid var(--color-border); }
        .chart-card__header { padding: var(--spacing-5); border-bottom: 1px solid var(--color-border-light); display: flex; justify-content: space-between; align-items: center; }
        .chart-card__title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin: 0; }
        .chart-card__body { padding: var(--spacing-5); }
        .chart-container { height: 300px; position: relative; }

        /* P&L Table */
        .pnl-table { width: 100%; border-collapse: collapse; }
        .pnl-table th, .pnl-table td { padding: var(--spacing-3) var(--spacing-4); text-align: right; border-bottom: 1px solid var(--color-border-light); }
        .pnl-table th:first-child, .pnl-table td:first-child { text-align: left; }
        .pnl-table th { font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); color: var(--color-text-muted); text-transform: uppercase; letter-spacing: var(--letter-spacing-wide); background: var(--color-background-alt); }
        .pnl-table__section { font-weight: var(--font-weight-semibold); background: var(--color-background-alt); }
        .pnl-table__total { font-weight: var(--font-weight-bold); border-top: 2px solid var(--color-border); }
        .pnl-table__positive { color: #059669; }
        .pnl-table__negative { color: var(--magenta-primary); }

        /* Forecast Cards */
        .forecast-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-4); }
        .forecast-card { background: var(--color-background-alt); border-radius: var(--radius-md); padding: var(--spacing-4); text-align: center; }
        .forecast-card__period { font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--spacing-2); }
        .forecast-card__value { font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); }
        .forecast-card__confidence { font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--spacing-1); }

        /* Expense Form */
        .expense-form { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-4); margin-bottom: var(--spacing-4); }
        .expense-form__field { display: flex; flex-direction: column; gap: var(--spacing-2); }
        .expense-form__label { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); }
        .expense-form__input { padding: var(--spacing-3); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: var(--font-size-sm); }
        .expense-form__actions { grid-column: span 4; display: flex; justify-content: flex-end; gap: var(--spacing-3); }

        /* Responsive */
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-grid { grid-template-columns: 1fr; }
            .expense-form { grid-template-columns: repeat(2, 1fr); }
            .expense-form__actions { grid-column: span 2; }
        }
        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .forecast-grid { grid-template-columns: 1fr; }
            .expense-form { grid-template-columns: 1fr; }
            .expense-form__actions { grid-column: span 1; }
        }
    </style>
</head>
<body class="admin-body">
    <script>(function(){var t=localStorage.getItem('admin-theme')||'dark';document.documentElement.setAttribute('data-theme',t);})()</script>
<script>window.location.replace('/html/admin/index.html');</script>
    <aside class="admin-sidebar">
        <div class="admin-sidebar__logo">
            <a href="/html/admin/index.html">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/>
                </svg>
                <span>InkCartridges</span>
            </a>
        </div>
        <nav class="admin-nav"></nav>
        <div class="admin-sidebar__user">
            <div class="admin-sidebar__avatar" id="admin-avatar">A</div>
            <div class="admin-sidebar__user-info">
                <div class="admin-sidebar__user-name" id="admin-name">Admin</div>
                <div class="admin-sidebar__user-role" id="admin-email">admin@example.com</div>
            </div>
        </div>
        <div class="admin-sidebar__store-link">
            <a href="/html/index.html">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                <span>View Store</span>
            </a>
        </div>
    </aside>

    <main class="admin-main">
        <header class="admin-header" style="background: var(--color-background); border-bottom: 1px solid var(--color-border); padding: var(--spacing-4) var(--spacing-6); display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); margin: 0;">Financial Health</h1>
                <p style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin: var(--spacing-1) 0 0;">Cash flow, P&L, and runway projections</p>
            </div>
            <div style="display: flex; gap: var(--spacing-3); align-items: center;">
                <div class="admin-chart__period">
                    <button class="admin-chart__period-btn" data-period="1h">1H</button>
                    <button class="admin-chart__period-btn" data-period="12h">12H</button>
                    <button class="admin-chart__period-btn" data-period="24h">24H</button>
                    <button class="admin-chart__period-btn admin-chart__period-btn--active" data-period="7d">7D</button>
                    <button class="admin-chart__period-btn" data-period="1m">1M</button>
                    <button class="admin-chart__period-btn" data-period="3m">3M</button>
                    <button class="admin-chart__period-btn" data-period="6m">6M</button>
                    <button class="admin-chart__period-btn" data-period="1y">1Y</button>
                    <button class="admin-chart__period-btn" data-period="2y">2Y</button>
                </div>
                <button class="btn btn--secondary btn--sm" id="export-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export
                </button>
                <button class="btn btn--primary btn--sm" id="add-expense-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add Expense
                </button>
            </div>
        </header>

        <div class="admin-page-content">
            <!-- Alert Banner -->
            <div class="alert-banner alert-banner--warning" id="runway-alert" style="display: none;">
                <div class="alert-banner__icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                </div>
                <div class="alert-banner__content">
                    <div class="alert-banner__title" id="alert-title">Cash Runway Warning</div>
                    <div class="alert-banner__text" id="alert-text">Your current runway is below the recommended threshold.</div>
                </div>
                <button class="btn btn--sm" id="alert-action">Review Expenses</button>
            </div>

            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card kpi-card--highlight">
                    <div class="kpi-card__header">
                        <div class="kpi-card__icon kpi-card__icon--cash">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        </div>
                        <div class="kpi-card__trend" id="cash-trend">
                            <span>--</span>
                        </div>
                    </div>
                    <div class="kpi-card__value" id="cash-balance">$0.00</div>
                    <div class="kpi-card__label">Cash Balance</div>
                    <div class="kpi-card__sublabel">As of today</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-card__header">
                        <div class="kpi-card__icon kpi-card__icon--profit">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
                        </div>
                        <div class="kpi-card__trend" id="margin-trend">
                            <span>--</span>
                        </div>
                    </div>
                    <div class="kpi-card__value" id="gross-margin">0%</div>
                    <div class="kpi-card__label">Gross Margin</div>
                    <div class="kpi-card__sublabel">This month</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-card__header">
                        <div class="kpi-card__icon kpi-card__icon--burn">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                        </div>
                        <div class="kpi-card__trend" id="burn-trend">
                            <span>--</span>
                        </div>
                    </div>
                    <div class="kpi-card__value" id="monthly-burn">$0</div>
                    <div class="kpi-card__label">Monthly Burn Rate</div>
                    <div class="kpi-card__sublabel">Net cash out</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-card__header">
                        <div class="kpi-card__icon kpi-card__icon--runway">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        </div>
                    </div>
                    <div class="kpi-card__value" id="runway-months">∞</div>
                    <div class="kpi-card__label">Cash Runway</div>
                    <div class="kpi-card__sublabel" id="runway-days">At current burn rate</div>
                </div>
            </div>

            <!-- Cash Flow & P&L Charts -->
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-card__header">
                        <h2 class="chart-card__title">Cash Flow</h2>
                        <select class="btn btn--secondary btn--sm" id="cashflow-period" style="padding: 6px 12px;">
                            <option value="6">Last 6 Months</option>
                            <option value="12" selected>Last 12 Months</option>
                            <option value="24">Last 24 Months</option>
                        </select>
                    </div>
                    <div class="chart-card__body">
                        <div class="chart-container">
                            <canvas id="cashflow-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-card__header">
                        <h2 class="chart-card__title">Revenue Forecasts</h2>
                    </div>
                    <div class="chart-card__body">
                        <div class="forecast-grid">
                            <div class="forecast-card">
                                <div class="forecast-card__period">30 Days</div>
                                <div class="forecast-card__value" id="forecast-30">$0</div>
                                <div class="forecast-card__confidence">±15% confidence</div>
                            </div>
                            <div class="forecast-card">
                                <div class="forecast-card__period">60 Days</div>
                                <div class="forecast-card__value" id="forecast-60">$0</div>
                                <div class="forecast-card__confidence">±20% confidence</div>
                            </div>
                            <div class="forecast-card">
                                <div class="forecast-card__period">90 Days</div>
                                <div class="forecast-card__value" id="forecast-90">$0</div>
                                <div class="forecast-card__confidence">±25% confidence</div>
                            </div>
                        </div>
                        <div style="margin-top: var(--spacing-5);">
                            <h3 style="font-size: var(--font-size-md); margin-bottom: var(--spacing-3);">Break-Even Status</h3>
                            <div style="display: flex; align-items: center; gap: var(--spacing-4);">
                                <div id="breakeven-indicator" style="width: 16px; height: 16px; border-radius: 50%; background: #10b981;"></div>
                                <div>
                                    <div style="font-weight: var(--font-weight-semibold);" id="breakeven-status">Profitable</div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-muted);" id="breakeven-gap">Revenue exceeds expenses</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P&L Statement -->
            <div class="chart-card" style="margin-bottom: var(--spacing-6);">
                <div class="chart-card__header">
                    <h2 class="chart-card__title">Profit & Loss Statement</h2>
                    <select class="btn btn--secondary btn--sm" id="pnl-period" style="padding: 6px 12px;">
                        <option value="current">Current Month</option>
                        <option value="last">Last Month</option>
                        <option value="quarter" selected>This Quarter</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                <div class="chart-card__body" style="padding: 0;">
                    <table class="pnl-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Current Period</th>
                                <th>Previous Period</th>
                                <th>Change</th>
                            </tr>
                        </thead>
                        <tbody id="pnl-tbody">
                            <tr class="pnl-table__section">
                                <td colspan="4">Revenue</td>
                            </tr>
                            <tr>
                                <td>Gross Sales</td>
                                <td id="pnl-gross-sales">$0.00</td>
                                <td id="pnl-gross-sales-prev">$0.00</td>
                                <td id="pnl-gross-sales-change">0%</td>
                            </tr>
                            <tr>
                                <td>Discounts & Returns</td>
                                <td class="pnl-table__negative" id="pnl-discounts">-$0.00</td>
                                <td id="pnl-discounts-prev">-$0.00</td>
                                <td id="pnl-discounts-change">0%</td>
                            </tr>
                            <tr class="pnl-table__total">
                                <td>Net Revenue</td>
                                <td id="pnl-net-revenue">$0.00</td>
                                <td id="pnl-net-revenue-prev">$0.00</td>
                                <td id="pnl-net-revenue-change">0%</td>
                            </tr>
                            <tr class="pnl-table__section">
                                <td colspan="4">Cost of Goods Sold</td>
                            </tr>
                            <tr>
                                <td>Product Costs</td>
                                <td class="pnl-table__negative" id="pnl-cogs">-$0.00</td>
                                <td id="pnl-cogs-prev">-$0.00</td>
                                <td id="pnl-cogs-change">0%</td>
                            </tr>
                            <tr>
                                <td>Shipping Costs</td>
                                <td class="pnl-table__negative" id="pnl-shipping">-$0.00</td>
                                <td id="pnl-shipping-prev">-$0.00</td>
                                <td id="pnl-shipping-change">0%</td>
                            </tr>
                            <tr class="pnl-table__total">
                                <td>Gross Profit</td>
                                <td class="pnl-table__positive" id="pnl-gross-profit">$0.00</td>
                                <td id="pnl-gross-profit-prev">$0.00</td>
                                <td id="pnl-gross-profit-change">0%</td>
                            </tr>
                            <tr class="pnl-table__section">
                                <td colspan="4">Operating Expenses</td>
                            </tr>
                            <tr>
                                <td>Marketing & Advertising</td>
                                <td class="pnl-table__negative" id="pnl-marketing">-$0.00</td>
                                <td id="pnl-marketing-prev">-$0.00</td>
                                <td id="pnl-marketing-change">0%</td>
                            </tr>
                            <tr>
                                <td>Platform & Software</td>
                                <td class="pnl-table__negative" id="pnl-platform">-$0.00</td>
                                <td id="pnl-platform-prev">-$0.00</td>
                                <td id="pnl-platform-change">0%</td>
                            </tr>
                            <tr>
                                <td>Other Operating</td>
                                <td class="pnl-table__negative" id="pnl-other">-$0.00</td>
                                <td id="pnl-other-prev">-$0.00</td>
                                <td id="pnl-other-change">0%</td>
                            </tr>
                            <tr class="pnl-table__total" style="background: var(--cyan-light);">
                                <td><strong>Net Profit</strong></td>
                                <td class="pnl-table__positive" id="pnl-net-profit"><strong>$0.00</strong></td>
                                <td id="pnl-net-profit-prev"><strong>$0.00</strong></td>
                                <td id="pnl-net-profit-change"><strong>0%</strong></td>
                            </tr>
                            <tr>
                                <td>Net Margin</td>
                                <td id="pnl-net-margin">0%</td>
                                <td id="pnl-net-margin-prev">0%</td>
                                <td id="pnl-net-margin-change">0 pts</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Expense Entry Form (hidden by default) -->
            <div class="chart-card" id="expense-form-card" style="display: none; margin-bottom: var(--spacing-6);">
                <div class="chart-card__header">
                    <h2 class="chart-card__title">Add Expense</h2>
                    <button class="btn btn--secondary btn--sm" id="close-expense-form">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="chart-card__body">
                    <form class="expense-form" id="expense-form">
                        <div class="expense-form__field">
                            <label class="expense-form__label">Category</label>
                            <select class="expense-form__input" id="expense-category" required>
                                <option value="">Select category...</option>
                                <option value="cogs">Cost of Goods Sold</option>
                                <option value="shipping">Shipping & Fulfillment</option>
                                <option value="marketing-paid">Marketing - Paid Ads</option>
                                <option value="marketing-organic">Marketing - Organic</option>
                                <option value="platform">Platform Fees</option>
                                <option value="rent">Rent & Utilities</option>
                                <option value="salaries">Salaries & Wages</option>
                                <option value="software">Software & Tools</option>
                                <option value="professional">Professional Services</option>
                                <option value="insurance">Insurance</option>
                                <option value="other">Other Operating</option>
                            </select>
                        </div>
                        <div class="expense-form__field">
                            <label class="expense-form__label">Amount (NZD)</label>
                            <input type="number" class="expense-form__input" id="expense-amount" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                        <div class="expense-form__field">
                            <label class="expense-form__label">Date</label>
                            <input type="date" class="expense-form__input" id="expense-date" required>
                        </div>
                        <div class="expense-form__field">
                            <label class="expense-form__label">Vendor / Description</label>
                            <input type="text" class="expense-form__input" id="expense-vendor" placeholder="e.g., Google Ads">
                        </div>
                        <div class="expense-form__actions">
                            <button type="button" class="btn btn--secondary" id="cancel-expense">Cancel</button>
                            <button type="submit" class="btn btn--primary">Save Expense</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Recent Expenses -->
            <div class="chart-card">
                <div class="chart-card__header">
                    <h2 class="chart-card__title">Recent Expenses</h2>
                </div>
                <div class="chart-card__body" style="padding: 0;">
                    <table class="pnl-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Vendor</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="recent-expenses-tbody">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: var(--spacing-6); color: var(--color-text-muted);">
                                    No expenses recorded yet. Click "Add Expense" to get started.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/config.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/admin-nav.js"></script>
    <script src="/js/admin.js"></script>
    <script src="/js/analytics-api.js"></script>
    <script>
    const FinancialHealthPage = {
        charts: {},
        data: {
            cashFlow: [],
            pnl: {},
            expenses: []
        },

        async init() {
            this.bindEvents();
            await this.loadData();
            this.checkAlerts();
        },

        bindEvents() {
            // Period filter buttons
            document.querySelectorAll('.admin-chart__period-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.admin-chart__period-btn').forEach(b =>
                        b.classList.remove('admin-chart__period-btn--active'));
                    e.target.classList.add('admin-chart__period-btn--active');
                    this.currentPeriod = e.target.dataset.period;
                    this.loadData();
                });
            });

            // Add expense button
            document.getElementById('add-expense-btn').addEventListener('click', () => {
                document.getElementById('expense-form-card').style.display = 'block';
                document.getElementById('expense-date').valueAsDate = new Date();
            });

            // Close expense form
            document.getElementById('close-expense-form').addEventListener('click', () => {
                document.getElementById('expense-form-card').style.display = 'none';
            });

            document.getElementById('cancel-expense').addEventListener('click', () => {
                document.getElementById('expense-form-card').style.display = 'none';
            });

            // Expense form submission
            document.getElementById('expense-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.saveExpense();
            });

            // Period selectors
            document.getElementById('cashflow-period').addEventListener('change', (e) => {
                this.loadCashFlowChart(parseInt(e.target.value));
            });

            document.getElementById('pnl-period').addEventListener('change', (e) => {
                this.loadPnL(e.target.value);
            });
        },

        async loadData() {
            try {
                // Load orders for revenue calculations
                const ordersResponse = await API.getOrders({ limit: 500 });
                const orders = ordersResponse.success ? (ordersResponse.data?.orders || []) : [];

                // Calculate financial metrics from orders
                this.calculateMetrics(orders);

                // Load cash flow chart
                this.loadCashFlowChart(12);

                // Load P&L
                this.loadPnL('quarter');

            } catch (error) {
                console.error('Error loading financial data:', error);
            }
        },

        calculateMetrics(orders) {
            // Calculate totals
            const now = new Date();
            const thisMonth = orders.filter(o => {
                const orderDate = new Date(o.created_at);
                return orderDate.getMonth() === now.getMonth() &&
                       orderDate.getFullYear() === now.getFullYear() &&
                       o.status !== 'cancelled' && o.status !== 'refunded';
            });

            const lastMonth = orders.filter(o => {
                const orderDate = new Date(o.created_at);
                const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                return orderDate.getMonth() === lastMonthDate.getMonth() &&
                       orderDate.getFullYear() === lastMonthDate.getFullYear() &&
                       o.status !== 'cancelled' && o.status !== 'refunded';
            });

            const thisMonthRevenue = thisMonth.reduce((sum, o) => sum + (o.total || 0), 0);
            const lastMonthRevenue = lastMonth.reduce((sum, o) => sum + (o.total || 0), 0);

            // Estimate COGS at 60% (typical for ink cartridges)
            const cogsRate = 0.60;
            const thisMonthCogs = thisMonthRevenue * cogsRate;
            const grossProfit = thisMonthRevenue - thisMonthCogs;
            const grossMargin = thisMonthRevenue > 0 ? (grossProfit / thisMonthRevenue) * 100 : 0;

            // Estimate expenses (placeholder - would come from expenses table)
            const monthlyExpenses = 2000; // Placeholder
            const netProfit = grossProfit - monthlyExpenses;

            // Calculate burn rate (if not profitable)
            const monthlyBurn = Math.max(0, monthlyExpenses - grossProfit);

            // Estimate cash balance (placeholder - would come from actual banking data)
            const estimatedCash = 50000; // Placeholder

            // Calculate runway
            const runway = monthlyBurn > 0 ? estimatedCash / monthlyBurn : Infinity;

            // Update KPIs
            document.getElementById('cash-balance').textContent = formatPrice(estimatedCash);
            document.getElementById('gross-margin').textContent = grossMargin.toFixed(1) + '%';
            document.getElementById('monthly-burn').textContent = monthlyBurn > 0 ? formatPrice(monthlyBurn) : '$0 (profitable)';

            if (runway === Infinity) {
                document.getElementById('runway-months').textContent = '∞';
                document.getElementById('runway-days').textContent = 'Business is profitable';
            } else {
                document.getElementById('runway-months').textContent = runway.toFixed(1) + ' mo';
                document.getElementById('runway-days').textContent = `~${Math.round(runway * 30)} days at current burn`;
            }

            // Update forecasts (simple linear projection)
            const avgDailyRevenue = thisMonthRevenue / new Date().getDate();
            document.getElementById('forecast-30').textContent = formatPrice(avgDailyRevenue * 30);
            document.getElementById('forecast-60').textContent = formatPrice(avgDailyRevenue * 60);
            document.getElementById('forecast-90').textContent = formatPrice(avgDailyRevenue * 90);

            // Update break-even status
            if (netProfit >= 0) {
                document.getElementById('breakeven-indicator').style.background = '#10b981';
                document.getElementById('breakeven-status').textContent = 'Profitable';
                document.getElementById('breakeven-gap').textContent = `Net profit: ${formatPrice(netProfit)}/month`;
            } else {
                document.getElementById('breakeven-indicator').style.background = 'var(--magenta-primary)';
                document.getElementById('breakeven-status').textContent = 'Below Break-Even';
                document.getElementById('breakeven-gap').textContent = `Need ${formatPrice(Math.abs(netProfit))} more revenue/month`;
            }

            // Store for P&L
            this.data.thisMonthRevenue = thisMonthRevenue;
            this.data.lastMonthRevenue = lastMonthRevenue;
            this.data.thisMonthCogs = thisMonthCogs;
            this.data.grossProfit = grossProfit;
            this.data.monthlyExpenses = monthlyExpenses;
            this.data.netProfit = netProfit;
            this.data.runway = runway;
        },

        loadCashFlowChart(months) {
            const ctx = document.getElementById('cashflow-chart');
            if (!ctx) return;

            if (this.charts.cashflow) this.charts.cashflow.destroy();

            // Generate month labels
            const labels = [];
            const inflows = [];
            const outflows = [];
            const netFlow = [];

            for (let i = months - 1; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                labels.push(d.toLocaleDateString('en-NZ', { month: 'short', year: '2-digit' }));

                // Data comes from API - shows 0 until backend provides cash flow data
                inflows.push(0);
                outflows.push(0);
                netFlow.push(0);
            }

            this.charts.cashflow = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Inflows',
                            data: inflows,
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        },
                        {
                            label: 'Outflows',
                            data: outflows.map(v => -v),
                            backgroundColor: '#C71F6E',
                            borderRadius: 4
                        },
                        {
                            label: 'Net Cash Flow',
                            data: netFlow,
                            type: 'line',
                            borderColor: '#267FB5',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#267FB5'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { stacked: false },
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => '$' + (v / 1000).toFixed(0) + 'k' }
                        }
                    }
                }
            });
        },

        loadPnL(period) {
            // Update P&L table with calculated values
            // This would typically fetch from the backend based on period

            const revenue = this.data.thisMonthRevenue || 0;
            const prevRevenue = this.data.lastMonthRevenue || 0;
            const cogs = this.data.thisMonthCogs || 0;
            const grossProfit = this.data.grossProfit || 0;
            const expenses = this.data.monthlyExpenses || 0;
            const netProfit = this.data.netProfit || 0;

            // Update table cells
            document.getElementById('pnl-gross-sales').textContent = formatPrice(revenue);
            document.getElementById('pnl-gross-sales-prev').textContent = formatPrice(prevRevenue);
            document.getElementById('pnl-gross-sales-change').textContent = this.calculateChange(revenue, prevRevenue);

            document.getElementById('pnl-net-revenue').textContent = formatPrice(revenue * 0.98); // After discounts
            document.getElementById('pnl-net-revenue-prev').textContent = formatPrice(prevRevenue * 0.98);

            document.getElementById('pnl-cogs').textContent = '-' + formatPrice(cogs);
            document.getElementById('pnl-cogs-prev').textContent = '-' + formatPrice(prevRevenue * 0.6);

            document.getElementById('pnl-gross-profit').textContent = formatPrice(grossProfit);
            document.getElementById('pnl-gross-profit-prev').textContent = formatPrice(prevRevenue * 0.4);

            document.getElementById('pnl-net-profit').innerHTML = '<strong>' + formatPrice(netProfit) + '</strong>';
            document.getElementById('pnl-net-margin').textContent = revenue > 0 ? (netProfit / revenue * 100).toFixed(1) + '%' : '0%';

            // Update color classes
            const netProfitCell = document.getElementById('pnl-net-profit');
            netProfitCell.className = netProfit >= 0 ? 'pnl-table__positive' : 'pnl-table__negative';
        },

        calculateChange(current, previous) {
            if (previous === 0) return current > 0 ? '+∞' : '0%';
            const change = ((current - previous) / previous) * 100;
            return (change >= 0 ? '+' : '') + change.toFixed(1) + '%';
        },

        checkAlerts() {
            const runway = this.data.runway;

            if (runway !== undefined && runway < 90 && runway !== Infinity) {
                const alertBanner = document.getElementById('runway-alert');
                alertBanner.style.display = 'flex';

                if (runway < 45) {
                    alertBanner.className = 'alert-banner alert-banner--critical';
                    document.getElementById('alert-title').textContent = 'Critical: Low Cash Runway';
                    document.getElementById('alert-text').textContent = `Only ${Math.round(runway)} months of runway remaining. Immediate action required.`;
                } else {
                    alertBanner.className = 'alert-banner alert-banner--warning';
                    document.getElementById('alert-title').textContent = 'Warning: Cash Runway Below Target';
                    document.getElementById('alert-text').textContent = `${Math.round(runway)} months runway. Target is 6+ months.`;
                }
            }
        },

        async saveExpense() {
            const category = document.getElementById('expense-category').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const date = document.getElementById('expense-date').value;
            const vendor = document.getElementById('expense-vendor').value;

            if (!category || !amount || !date) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                // In production, this would call the API
                // await AnalyticsAPI.addExpense({ category, amount, date, vendor });

                // For now, show success and reset form
                alert('Expense saved successfully!');
                document.getElementById('expense-form').reset();
                document.getElementById('expense-form-card').style.display = 'none';

                // Reload data
                await this.loadData();

            } catch (error) {
                console.error('Error saving expense:', error);
                alert('Failed to save expense. Please try again.');
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => { FinancialHealthPage.init(); }, 500);
    });
    </script>
    <script src="/js/modern-effects.js"></script>
</body>
</html>
